#!/bin/bash

mydir=`dirname $0`
cd $mydir

ts=`date +"%s"`
dt=`date +"%Y%m%d-%H%M"`
tlTemp=/tmp/timeLapse
source .config

./wyzecapture

[ ! -d ${tlTemp} ] && mkdir -p ${tlTemp}
cp ${pathToFile}/${wyzeFileName} ${tlTemp}/timelapse-${ts}.jpg

# Overlay graph
# overlay plot on the video
#composite -gravity South ${pathToFile}/weatherBandit.png ${pathToFile}/${wyzeFileName} -define filter:option=average -resize 800x600 ${pathToFile}/test.png
convert ${pathToFile}/${wyzeFileName} -gravity SouthWest -transparent-color white -geometry 1600x700 ${pathToFile}/overlay-graph.png -compose ModulusSubtract -define compose:args=30 -composite -set option:modulate:colorspace hsb -background none -resize 1024x768 ${tlTemp}/timelapse-${ts}.jpg

cp ${tlTemp}/timelapse-${ts}.jpg ${pathToFile}/${wyzeFileName} 

## add morning and evening detection to trigger this
## frame = black and files>48 (4hr) : run ffmpeg
## frame = black and only file (3?) : delete
fc=`ls ${tlTemp}/timelapse-*.jpg | wc -l`
br=`./brightness` 

echo Files $fc brightness $br > /tmp/timelapseStatus.log

if [ $br -eq -1 ]
then
	echo No image from camera. Bailing out..
	exit -1
fi

# morning means more than 3 bright pics
if [ $br -le 45 -a $fc -le 3 ]
then
	rm -f ${tlTemp}/timelapse-*.jpg
fi

# evening means low brightness and pleanty of pictures
if [ $br -le 45 -a $fc -ge 50 ]
then
	cat ${tlTemp}/*.jpg | ffmpeg -f image2pipe -r 1 -vcodec mjpeg -i - -vcodec libx264 ${tlTemp}/timelapse-${dt}.mp4
	mv ${tlTemp}/timelapse-${dt}.mp4 ${pathToFile}/
	rm -f ${tlTemp}/timelapse-*.jpg 
fi

 
